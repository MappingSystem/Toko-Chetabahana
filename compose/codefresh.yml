version: '1.0'
steps:
  read_token:
    title: 'Read Github token'
    image: codefresh/cli
    commands:
      - cf_export GITHUB_TOKEN=$(codefresh get context github --decrypt -o yaml | yq -y .spec.data.auth.password)

  main_clone:
    title: 'Checking out code'
    image: python:latest
    commands:
      - rm -Rf $WORKSPACE && git clone $GIT_URL/${GIT_USER_NAME}/$WORKSPACE.git && cd $WORKSPACE
      - find . -type d -name cf -exec bash {}/python.bash \;

  test_image:
    title: Run compose
    type: composition
    working_directory: compose/home/chetabahana/.docker/compose
    arguments:
      composition: codefresh-composition.yml
      composition_candidates:
        saleor:
          image: chetabahana/saleor
          env_file: codefresh.env
          user: saleor:saleor
          command: pytest
          volumes:
            - '${{CF_VOLUME_NAME}}:${{CF_VOLUME_PATH}}'
          networks:
            - network_tier
          depends_on:
            - postgres
            - redis
    
