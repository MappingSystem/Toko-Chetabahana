version: '1.0'
steps:
  get_git_token:
    title: Reading Github token
    image: codefresh/cli
    commands:
      - cf_export GITHUB_TOKEN=$(codefresh get context github --decrypt -o yaml | yq -y .spec.data.auth.password)
  main_clone:
    title: Cloning the repo
    image: alpine/git:latest
    commands:
      - if [ -d branches ]; then rm -Rf branches; fi
      - git clone https://chetabahana:$GITHUB_TOKEN@github.com/chetabahana/branches.git
      - cd branches && git remote rm origin
      - git config --global user.name "chetabahana"
      - git config --global user.email "chetabahana@gmail.com"
      - git remote add origin https://chetabahana:$GITHUB_TOKEN@github.com/chetabahana/branches.git
      - sed -i "s/-[0-9]\{1,\}-\([a-zA-Z0-9_]*\)'/-`date +%d%H%M`-cron'/g" cloudbuild.yaml
      - git status && git add . && git commit -m "codefresh commit" && git push -u origin master
