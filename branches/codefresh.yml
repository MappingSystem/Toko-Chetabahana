version: '1.0'
steps:
  read_token:
    title: 'Read token'
    image: codefresh/cli
    commands:
      - GITHUB_TOKEN=$(codefresh get context github --decrypt -o yaml | yq -y .spec.data.auth.password)
      - cf_export GIT_URL=https://${CF_ACCOUNT}:${GITHUB_TOKEN}

  main_clone:
    title: 'Clone repo'
    image: alpine:latest
    commands:
      - cd ${CF_VOLUME_PATH} && rm -rf .io ${CF_REPO_NAME}
      - git clone $GIT_URL@github.com/${CF_REPO_OWNER}/${CF_REPO_NAME}
      - cd ${CF_REPO_NAME} && git checkout -B ${CF_BUILD_INITIATOR}
      - git config --global user.name ${GIT_USER_NAME}
      - git config --global user.email ${GIT_USER_EMAIL}

  test_clone:
    title: 'Check repo'
    image: python:latest
    commands:
      - cd ${CF_VOLUME_PATH} && rm -rf .io
      - git clone $GIT_URL@github.com/${CF_ACCOUNT}/$WORKSPACE .io
      - find .io -type d -name ${CF_REPO_NAME} -exec cp -frpT {} ${CF_REPO_NAME} \;
      - find .io -type d -name ${CF_ACCOUNT} -exec cp -frpT {} $HOME \;
      - find .io -type f -name python.env -exec bash {} \;

  git_update:
    title: 'Update git'
    image: alpine:latest
    commands:
      - cd ${CF_VOLUME_PATH}/${CF_REPO_NAME}
      - sed -i "s/-[0-9]\{1,\}-\([a-zA-Z0-9_]*\)'/-`date +%d%H%M`-cron'/g" cloudbuild.yaml
      - rm -rf access.json docker-stack.yml .cf .config .io .ssh .transifexrc
      - git add . && git commit -m "Add support for taxonomy" 
      - git push -u origin ${CF_BUILD_INITIATOR}
      - git status
