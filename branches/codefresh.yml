version: '1.0'
steps:
  get_git_token:
    title: Reading Github token
    image: codefresh/cli
    commands:
      - GITHUB_TOKEN=$(codefresh get context github --decrypt -o yaml | yq -y .spec.data.auth.password)
      - cf_export GIT_URL=https://chetabahana:$GITHUB_TOKEN@github.com
      - cf_export WORKSPACE=`pwd`
  main_clone:
    title: Cloning the repo
    image: alpine/git:latest
    commands:
      - cd $WORKSPACE
      - rm -Rf branches saleor
      - git clone $GIT_URL/mirumee/saleor.git
      - git clone $GIT_URL/chetabahana/branches.git
  main_update:
    title: Updating the repo
    image: alpine/git:latest
    commands:
      - cd $WORKSPACE
      - cd branches && git remote rm origin
      - git config --global user.name "chetabahana"
      - git config --global user.email "chetabahana@gmail.com"
      - git remote add origin $GIT_URL/chetabahana/branches.git
      - sed -i "s/-[0-9]\{1,\}-\([a-zA-Z0-9_]*\)'/-`date +%d%H%M`-cron'/g" cloudbuild.yaml
      - git status && git add . && git commit -m "codefresh commit" && git push -u origin master
